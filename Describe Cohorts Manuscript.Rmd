---
title: "Describe Cohorts Manuscript"
author: "Chase Latour"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(targets)
library(tidyverse)
library(kableExtra)
```

# Objetives

The goal of this program is to describe the pregnancy cohorts created for each analytic dataset.

# Data

First, we must read in the necessary data files. 

```{r}

describe <- tar_read(all_descriptives)

describe_analytic1 <- tar_read(all_descriptives_analytic)

describe_analytic <- describe %>% 
  mutate(
    n_low_num = as.double(str_extract(n_low, "^\\d+")),
    n_med_num = as.double(str_extract(n_med, "^\\d+")),
    n_high_num = as.double(str_extract(n_high, "^\\d+")),
    n_total = n_low_num + n_med_num + n_high_num,
    n_preec = as.double(str_extract(n_preeclampsia, "^\\d+")),
  ) %>% 
  select(trt, rr_abortion, rr_preec, marginal_p_miss_severity,
         marginal_p_miss_miscarriage, n_total, n_preec) %>% 
  left_join(describe_analytic1, by = c("trt", "rr_abortion", "rr_preec", 
                                       "marginal_p_miss_severity", 
                                       "marginal_p_miss_miscarriage"))

analyses <- tar_read(all_analyses)

```

# Functions

Make a function that outputs a table describing a DGM

```{r}


describe_cohorts <- function(describe_subset){
  
  hold <- describe_subset %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           missing_mar, missing_mnar, trt,
           n_low, n_med, n_high, 
           n_miscarriage_all, n_stillbirth_all, n_livebirth_all) %>% 
    kbl() %>%
    collapse_rows(col_names = c(pnc_wk, marginal_p_miss_severity, marginal_p_miss_miscarriage),
                  valign = "top") %>%
    kable_classic()
  
  return(hold)
  
}

# Describe the number of pregnancies and observed preeclampsia events in each analytic sample

describe_pregnancies <- function(describe_subset){
  
  hold <- describe_subset %>% 
    mutate(marginal_p_miscarriage = marginal_p_miss_miscarriage / 4.9) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           trt, n_total, n_preec, n_pregnancies_deliveries, n_preeclampsia_deliveries, n_pregnancies_outcomes,
           n_preeclampsia_outcomes, n_pregnancies_all, n_preeclampsia_all) %>% 
    kbl() %>%
    collapse_rows(col_names = c(marginal_p_miss_severity, marginal_p_miss_miscarriage),
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(
      c("Missing probabilities" = 2,
        "Treatment" = 1,
        "Target Population" = 2,
        "Observed Deliveries" = 2,
        "Observed Outcomes" = 2,
        "Observed Pregnancies" = 2)
    )
    
  return(hold)
  
}

```

Make a function that outputs the analytic results for a DGM

```{r}

# First, prepare the dataset
analyses2 <- analyses %>% 
  mutate(
    truth = map(potential_risks, ~.x %>% rename_with(~paste0("truth_", .))),
    observed_del = map(observed_deliveries, ~.x %>%  rename_with(~paste0("obs_del_", .))),
    observed_out = map(observed_outcomes, ~.x %>% rename_with(~paste0("obs_out_", .))),
    tte = map(tte, ~.x %>% rename_with(~paste0("all_preg_", .))),
    all_preg_or = map(all_preg_or, ~.x %>% rename_with(~paste0("all_preg_or_", .))), # ADDED
    all_outc = map(sens_anal_all_outc, ~.x %>% rename_with(~paste0("all_preg_all_outc_", .))),
    trt_outc = map(sens_anal_trt_outc, ~.x %>% rename_with(~paste0("trt_preg_outc_", .))),
    untrt_outc = map(sens_anal_untrt_out, ~.x %>% rename_with(~paste0("untrt_preg_outc_", .))),
    no_outc = map(sens_anal_no_outc, ~.x %>% rename_with(~paste0("all_preg_no_outc_", .)))
  ) %>% 
  select(rr_abortion, rr_preec, marginal_p_miss_severity, marginal_p_miss_miscarriage,
         truth, observed_del, observed_out, tte, all_preg_or, all_outc, # ADDED
         trt_outc, untrt_outc, no_outc) %>% 
  unnest(c(truth, observed_del, observed_out, tte, all_preg_or, # ADDED
           all_outc, trt_outc, untrt_outc, no_outc)) %>% 
  mutate(
    obs_del_risk0_bias = obs_del_risk0 - truth_risk0,
    obs_del_risk1_bias = obs_del_risk1 - truth_risk1,
    obs_del_rd_bias = obs_del_rd - truth_rd,
    obs_del_rr_bias = log(obs_del_rr) - log(truth_rr),
    obs_del_or_bias = log(obs_del_or) - log(truth_or),
    obs_out_risk0_bias = obs_out_risk0 - truth_risk0,
    obs_out_risk1_bias = obs_out_risk1 - truth_risk1,
    obs_out_rd_bias = obs_out_rd - truth_rd,
    obs_out_rr_bias = log(obs_out_rr) - log(truth_rr),
    obs_out_or_bias = log(obs_out_or) - log(truth_or),
    all_preg_risk0_bias = all_preg_risk0 - truth_risk0,
    all_preg_risk1_bias = all_preg_risk1 - truth_risk1,
    all_preg_rd_bias = all_preg_rd - truth_rd,
    all_preg_rr_bias = log(all_preg_rr) - log(truth_rr),
    all_preg_or_bias = log(all_preg_or_or) - log(truth_or),
    
    # Add in the bias for the sensitivity analyses
    all_preg_all_outc_risk0_bias = all_preg_all_outc_risk0 - truth_risk0,
    all_preg_all_outc_risk1_bias = all_preg_all_outc_risk1 - truth_risk1,
    all_preg_all_outc_rd_bias = all_preg_all_outc_rd - truth_rd,
    all_preg_all_outc_rr_bias = log(all_preg_all_outc_rr) - log(truth_rr),
    
    trt_preg_outc_risk0_bias = trt_preg_outc_risk0 - truth_risk0,
    trt_preg_outc_risk1_bias = trt_preg_outc_risk1 - truth_risk1,
    trt_preg_outc_rd_bias = trt_preg_outc_rd - truth_rd,
    trt_preg_outc_rr_bias = log(trt_preg_outc_rr) - log(truth_rr),
    
    untrt_preg_outc_risk0_bias = untrt_preg_outc_risk0 - truth_risk0,
    untrt_preg_outc_risk1_bias = untrt_preg_outc_risk1 - truth_risk1,
    untrt_preg_outc_rd_bias = untrt_preg_outc_rd - truth_rd,
    untrt_preg_outc_rr_bias = log(untrt_preg_outc_rr) - log(truth_rr),

    all_preg_no_outc_risk0_bias = all_preg_no_outc_risk0 - truth_risk0,
    all_preg_no_outc_risk1_bias = all_preg_no_outc_risk1 - truth_risk1,
    all_preg_no_outc_rd_bias = all_preg_no_outc_rd - truth_rd,
    all_preg_no_outc_rr_bias = log(all_preg_no_outc_rr) - log(truth_rr)
    
  ) %>% 
  # select(-c(ends_with("pnc_wk"), ends_with("risk0"), ends_with("risk1")))
  mutate(
    marginal_p_miss_severity = marginal_p_miss_severity, #1.13,
    marginal_p_miss_miscarriage = marginal_p_miss_miscarriage / 4.9
  ) %>% 
  select(-c(all_preg_or_risk0, all_preg_or_risk1, all_preg_or_rd, all_preg_or_rr))


print_analysis_kable_del <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_rr_bias, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr, truth_or,
           obs_del_risk1, obs_del_risk0, obs_del_rd, obs_del_rr, obs_del_or, 
           obs_del_risk1_bias, obs_del_risk0_bias, obs_del_rd_bias, obs_del_rr_bias,
           obs_del_or_bias) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      obs_del_risk1 = paste0(round(obs_del_risk1 * 100, 1), "%"),
      obs_del_risk0 = paste0(round(obs_del_risk0 * 100, 1), "%"),
    ) %>% 
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1,
      "$$OR$$" = 1), 3)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 5,
      "Observed Deliveries" = 5,
      "Observed Deliveries - Bias" = 5
    ))
  
  return(hold)
  
}


print_analysis_kable_outc <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_rr_bias, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr, truth_or, 
           obs_out_risk1, obs_out_risk0, obs_out_rd, obs_out_rr, obs_out_or,
           obs_out_risk1_bias, obs_out_risk0_bias, obs_out_rd_bias, obs_out_rr_bias,
           obs_out_or_bias) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      obs_out_risk1 = paste0(round(obs_out_risk1 * 100, 1), "%"),
      obs_out_risk0 = paste0(round(obs_out_risk0 * 100, 1), "%"),
    ) %>%
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1,
      "$$OR$$" = 1), 3)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 5,
      "Observed Outcomes" = 5,
      "Observed Outcomes - Bias" = 5
    ))
  
  return(hold)
  
}


print_analysis_kable_all <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_rr_bias, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr,
           all_preg_risk1, all_preg_risk0, all_preg_rd, all_preg_rr,
           all_preg_risk1_bias, all_preg_risk0_bias, all_preg_rd_bias, all_preg_rr_bias) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      all_preg_risk1 = paste0(round(all_preg_risk1 * 100, 1), "%"),
      all_preg_risk0 = paste0(round(all_preg_risk0 * 100, 1), "%"),
    ) %>%
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1), 3)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 4,
      "All Pregnancies" = 4,
      "All Pregnancies - Bias" = 4
    ))
  
  return(hold)
  
}


print_analysis_kable_all_outc <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_no_outc_rr, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr, truth_or,
           all_preg_all_outc_risk1, all_preg_all_outc_risk0, all_preg_all_outc_rd,
           all_preg_all_outc_rr, all_preg_all_outc_or) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      all_preg_all_outc_risk1 = paste0(round(all_preg_all_outc_risk1 * 100, 1), "%"),
      all_preg_all_outc_risk0 = paste0(round(all_preg_all_outc_risk0 * 100, 1), "%"),
    ) %>%
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1,
      "$$OR$$" = 1), 2)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 5,
      "Observed Deliveries" = 5
    ))
  
  return(hold)
  
}


print_analysis_kable_trt_outc <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_no_outc_rr, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr, truth_or,
           trt_preg_outc_risk1, trt_preg_outc_risk0, trt_preg_outc_rd, trt_preg_outc_rr,
           trt_preg_outc_or) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      trt_preg_outc_risk1 = paste0(round(trt_preg_outc_risk1 * 100, 1), "%"),
      trt_preg_outc_risk0 = paste0(round(trt_preg_outc_risk0 * 100, 1), "%"),
    ) %>%
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1,
      "$$OR$$" = 1), 2)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 5,
      "Observed Deliveries" = 5
    ))
  
  return(hold)
  
}



print_analysis_kable_untrt_outc <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_no_outc_rr, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr, truth_or,
           untrt_preg_outc_risk1, untrt_preg_outc_risk0, untrt_preg_outc_rd, 
           untrt_preg_outc_rr, untrt_preg_outc_or) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      untrt_preg_outc_risk1 = paste0(round(untrt_preg_outc_risk1 * 100, 1), "%"),
      untrt_preg_outc_risk0 = paste0(round(untrt_preg_outc_risk0 * 100, 1), "%"),
    ) %>%
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1,
      "$$OR$$" = 1), 2)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 5,
      "Observed Deliveries" = 5
    ))
  
  return(hold)
  
}




print_analysis_kable_no_outc <- function(data_subset){
  
  hold <- data_subset %>% 
    mutate(across(c(truth_rr, obs_del_rr, obs_out_rr, all_preg_rr,
                    all_preg_all_outc_rr, trt_preg_outc_rr,
                    untrt_preg_outc_rr, all_preg_no_outc_rr), ~round(.x, 2))) %>% 
    mutate(across(truth_risk0:all_preg_no_outc_rr, ~round(.x, 3))) %>% 
    select(!c(rr_abortion, rr_preec)) %>% 
    select(marginal_p_miss_severity, marginal_p_miss_miscarriage,
           truth_risk1, truth_risk0, truth_rd, truth_rr, truth_or,
           all_preg_no_outc_risk1, all_preg_no_outc_risk0, all_preg_no_outc_rd,
           all_preg_no_outc_rr, all_preg_no_outc_or) %>% 
    mutate(
      truth_risk1 = paste0(round(truth_risk1 * 100, 1), "%"),
      truth_risk0 = paste0(round(truth_risk0 * 100, 1), "%"),
      all_preg_no_outc_risk1 = paste0(round(all_preg_no_outc_risk1 * 100, 1), "%"),
      all_preg_no_outc_risk0 = paste0(round(all_preg_no_outc_risk0 * 100, 1), "%"),
    ) %>%
    kbl(col.names = NA) %>% # 
    collapse_rows(columns = 1:2,
                  valign = "top") %>%
    kable_classic() %>% 
    add_header_above(c(
      "Prob Missing Due to Severity" = 1,
      "Prob Missing Due to Abortion" = 1,
      rep(c("$$Risk_1$$" = 1,
      "$$Risk_0$$" = 1,
      "$$RD$$" = 1,
      "$$RR$$" = 1,
      "$$OR$$" = 1), 2)# 8)
    )) %>% 
    add_header_above(c(
      " " = 2,
      "Truth" = 5,
      "Observed Deliveries" = 5
    ))
  
  return(hold)
  
}





```

Make a function that outputs figures of the parameters. 

```{r}


###################################
## PARAMETERS

# Prep the parameter data for printing into figures.

figure_data <- analyses2 %>% 
  pivot_longer(
    cols = !c(rr_abortion, rr_preec, marginal_p_miss_severity, marginal_p_miss_miscarriage),
    names_to = "estimate",
    values_to = "value"
  ) %>% 
  mutate(
    Cohort = case_when(grepl("truth", estimate) ~ "Truth",
                       grepl("obs_del", estimate) ~ "Observed Deliveries",
                       grepl("obs_out", estimate) ~ "Observed Outcomes",
                       grepl("all_preg_all_outc", estimate) ~ "Sens: All Pregnancies Outcome",
                       grepl("untrt_preg_outc", estimate) ~ "Sens: Untrt Pregnancies Outcome",
                       grepl("trt_preg_outc", estimate) ~ "Sens: Trt Pregnancies Outcome",
                       grepl("all_preg_no_outc", estimate) ~ "Sens: All Pregnancies No Outcome",
                       grepl("all_preg", estimate) ~ "Observed Pregnancies"),
    parameter = case_when(grepl("_risk0", estimate) ~ "Risk, Non-Initiators",
                          grepl("_risk1", estimate) ~ "Risk, Initiators",
                          grepl("_rd", estimate) ~ "Risk Difference",
                          grepl("_rr", estimate) ~ "Risk Ratio",
                          grepl("_or", estimate) ~ "Odds Ratio"),
    missing = paste0(marginal_p_miss_severity,"/", marginal_p_miss_miscarriage) ,
    missing = factor(missing,
                     levels = c("0/0.05", "0.025/0.025", "0.05/0",
                                "0/0.2",  "0.1/0.1",     "0.2/0"))
  ) %>% 
  filter(!grepl("_bias", estimate))

truths <- figure_data %>% 
  filter(Cohort == "Truth") %>% 
  rename(truth = value) %>% 
  select(rr_abortion, rr_preec, missing, parameter, truth)

estimates <- figure_data %>% 
  filter(Cohort != "Truth")

figure_data2 <- left_join(estimates, truths, by = c("rr_abortion", "rr_preec",
                                                    "missing", "parameter")) %>% 
  mutate(
    scenario = case_when(
      rr_abortion == 0.5 ~ "Decrease risk of miscarriage",
      rr_abortion == 1.0 ~ "No effect on risk of miscarriage",
      rr_abortion == 2.0 ~ "Increase risk of miscarriage"
    ),
    scenario = factor(scenario, 
                      levels = c("Decrease risk of miscarriage",
                                 "No effect on risk of miscarriage",
                                 "Increase risk of miscarriage"))
  )


# Restrict to those results where ~5% of the study population is LTFU

figure_data2_5pct <- figure_data2 %>% 
  filter(missing %in% c("0/0.05", "0.025/0.025", "0.05/0"))

# Restrict ot those results where ~20% of the study population is LTFU

figure_data2_20pct <- figure_data2 %>% 
  filter(missing %in% c("0/0.2", "0.1/0.1", "0.2/0"))






###################################
## BIAS


# Prep the bias data for printing into figures.

bias_figure_data <- analyses2 %>% 
  pivot_longer(
    cols = !c(rr_abortion, rr_preec, marginal_p_miss_severity, marginal_p_miss_miscarriage),
    names_to = "estimate",
    values_to = "value"
  ) %>% 
  mutate(
    Cohort = case_when(grepl("truth", estimate) ~ "Truth",
                       grepl("obs_del", estimate) ~ "Observed Deliveries",
                       grepl("obs_out", estimate) ~ "Observed Outcomes",
                       grepl("all_preg_all_outc", estimate) ~ "Sens: All Pregnancies Outcome",
                       grepl("untrt_preg_outc", estimate) ~ "Sens: Untrt Pregnancies Outcome",
                       grepl("trt_preg_outc", estimate) ~ "Sens: Trt Pregnancies Outcome",
                       grepl("all_preg_no_outc", estimate) ~ "Sens: All Pregnancies No Outcome",
                       grepl("all_preg", estimate) ~ "Observed Pregnancies"),
    parameter = case_when(grepl("_risk0", estimate) ~ "Risk, Non-Initiators",
                          grepl("_risk1", estimate) ~ "Risk, Initiators",
                          grepl("_rd", estimate) ~ "Risk Difference",
                          grepl("_rr", estimate) ~ "Risk Ratio",
                          grepl("_or", estimate) ~ "Odds Ratio"),
    missing = paste0(marginal_p_miss_severity,"/", marginal_p_miss_miscarriage) ,
    missing = factor(missing,
                     levels = c("0/0.05", "0.025/0.025", "0.05/0",
                                "0/0.2",  "0.1/0.1",     "0.2/0"))
  ) %>% 
  filter(grepl("_bias", estimate)) %>% 
  mutate(
    scenario = case_when(
      rr_abortion == 0.5 ~ "Decrease risk of miscarriage",
      rr_abortion == 1.0 ~ "No effect on risk of miscarriage",
      rr_abortion == 2.0 ~ "Increase risk of miscarriage"
    ),
    scenario = factor(scenario, 
                      levels = c("Decrease risk of miscarriage",
                                 "No effect on risk of miscarriage",
                                 "Increase risk of miscarriage"))
  )


# Restrict to those results where ~5% of the study population is LTFU

bias_figure_data2_5pct <- bias_figure_data %>% 
  filter(missing %in% c("0/0.05", "0.025/0.025", "0.05/0"))

# Restrict ot those results where ~20% of the study population is LTFU

bias_figure_data2_20pct <- bias_figure_data %>% 
  filter(missing %in% c("0/0.2", "0.1/0.1", "0.2/0"))




```





# Output Tabular Results
Create kable with description of a specified dataset. Do this for each RR combination.

## First, output descriptives of whole population

Range of initiators versus non-initiators in the trial population

```{r}

# Extract numeric values from the character columns
intermediate <- describe %>% 
  mutate(
    n_low_num = as.double(str_extract(n_low, "^\\d+")),
    n_med_num = as.double(str_extract(n_med, "^\\d+")),
    n_high_num = as.double(str_extract(n_high, "^\\d+")),
    n_total = n_low_num + n_med_num + n_high_num,
    n_miscarriage_num = as.double(str_extract(n_miscarriage_all, "^\\d+")),
    n_stillbirth_num = as.double(str_extract(n_stillbirth_all, "^\\d+")),
    n_livebirth_num = as.double(str_extract(n_livebirth_all, "^\\d+")),
    n_missing_severity = as.double(str_extract(missing_mar, "^\\d+")),
    n_missing_mnar = as.double(str_extract(missing_mnar, "^\\d+")),
    n_missing_miscarriage = n_missing_mnar - n_missing_severity,
    marginal_p_miss_miscarriage = marginal_p_miss_miscarriage / 4.9
  )

included <- as.double(intermediate %>% 
  group_by(rr_abortion, rr_preec, marginal_p_miss_miscarriage, marginal_p_miss_severity) %>% 
  summarize(
    n_incl = sum(n_total),
    .groups = 'drop'
  ) %>% 
  # They all should have the same number included
  summarize(min(n_incl)))

intermediate %>% 
  group_by(trt) %>% 
  summarize(
    min = min(n_total),
    min_percent = round(100 * min / included, 0),
    max = max(n_total),
    max_percent = round(100 * max / included, 0)
  )
  

```
Range of initiators and non-initiators with high severity disease in the trial populations.

```{r}

intermediate %>% 
  mutate(
    perc_high_severity = round(100 * n_high_num / n_total, 0)
  ) %>% 
  group_by(trt) %>% 
  summarize(
    min_perc = min(perc_high_severity),
    max_perc = max(perc_high_severity)
  )


```


Range of Missingness by Scenarios

```{r}

intermediate %>% 
  filter(trt == 0) %>% 
  mutate(
    perc_missing_miscarriage = round(100 * n_missing_miscarriage / n_total, 0),
    perc_missing_severity = round(100 * n_missing_severity / n_total, 0)
  ) %>% 
  group_by(marginal_p_miss_miscarriage, marginal_p_miss_severity) %>% 
  summarize(
    min_perc_miscarriage = min(perc_missing_miscarriage),
    max_perc_miscarriage = max(perc_missing_miscarriage),
    min_perc_severity = min(perc_missing_severity),
    max_perc_severity = max(perc_missing_severity),
    .groups = "drop"
  ) %>% 
  kbl() %>% 
  kable_classic()


```




Distribution of pregnancy outcomes among untreated individuals.

```{r}

intermediate %>% 
  filter(trt == 0) %>% 
  mutate(
    miscarriage_perc = round(100 * n_miscarriage_num / n_total, 0),
    stillbirth_perc = round(100 * n_stillbirth_num / n_total, 0),
    livebirth_perc = round(100 * n_livebirth_num / n_total, 0)
  ) %>% 
  summarize(
    miscarriage_min = min(miscarriage_perc),
    miscarriage_avg = mean(miscarriage_perc),
    miscarriage_max = max(miscarriage_perc),
    stillbirth_min = min(stillbirth_perc),
    stillbirth_avg = mean(stillbirth_perc),
    stillbirth_max = max(stillbirth_perc),
    livebirth_min = min(livebirth_perc),
    livebirth_avg = mean(livebirth_perc),
    livebirth_max = max(livebirth_perc)
  )

```




## $RR_{Abortion} = 0.5, RR_{Preeclampsia} = 0.5$

```{r}
    
describe %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  describe_cohorts()

describe_analytic %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  describe_pregnancies()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_del()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_all()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_all_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_trt_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_untrt_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 0.5) %>% 
  print_analysis_kable_no_outc()



```


## $RR_{RR_{Abortion} = 1.0, Preeclampsia} = 0.5$

```{r}
    
describe %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  describe_cohorts()

describe_analytic %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  describe_pregnancies()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_del()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_all()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_all_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_trt_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_untrt_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 0.5) %>% 
  print_analysis_kable_no_outc()

```


## $RR_{RR_{Abortion} = 2.0, Preeclampsia} = 0.5$

```{r}
    
describe %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  describe_cohorts()

describe_analytic %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  describe_pregnancies()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_del()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_all()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_all_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_trt_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_untrt_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 0.5) %>% 
  print_analysis_kable_no_outc()

```


## $RR_{Abortion} = 0.5, RR_{Preeclampsia} = 1.0$

```{r}
    
describe %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  describe_cohorts()

describe_analytic %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  describe_pregnancies()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_del()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_all()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_all_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_trt_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_untrt_outc()

analyses2 %>% 
  filter(rr_abortion == 0.5 & rr_preec == 1.0) %>% 
  print_analysis_kable_no_outc()



```


## $RR_{RR_{Abortion} = 1.0, Preeclampsia} = 1.0$

```{r}
    
describe %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  describe_cohorts()

describe_analytic %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  describe_pregnancies()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_del()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_all()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_all_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_trt_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_untrt_outc()

analyses2 %>% 
  filter(rr_abortion == 1.0 & rr_preec == 1.0) %>% 
  print_analysis_kable_no_outc()

```


## $RR_{RR_{Abortion} = 2, Preeclampsia} = 1.0$

```{r}
    
describe %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  describe_cohorts()

describe_analytic %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  describe_pregnancies()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_del()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_all()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_all_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_trt_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_untrt_outc()

analyses2 %>% 
  filter(rr_abortion == 2 & rr_preec == 1.0) %>% 
  print_analysis_kable_no_outc()


```











# Figures: Bias by Effect on Miscarriage

Create the functions to output the figures.

```{r}

create_biasfigure_nosens <- function(dataset, parameter, rr_preec, title){
  
  param <- sym(parameter)
  # rr_abort <- sym(rr_abort)
  rr_preeclampsia <- sym(rr_preec)
  
  plot <- dataset %>%
    filter(!grepl("Sens", Cohort)) %>% 
    filter(rr_preec == rr_preeclampsia) %>%
    filter(parameter == param) %>% 
    ggplot(aes(x = scenario, y = value, color = Cohort, shape = Cohort)) + # , shape = cohort
    geom_point(size = 3, position = position_dodge(0.5)) +
    facet_wrap(missing ~., nrow = 1, 
               labeller = labeller(missing = 
                                     c("0/0.05" = "All MNAR: 0% Severity, 5% Miscarriage",
                                       "0.025/0.025" = "MAR+MNAR: 2.5% Severity, 2.5% Miscarriage",
                                       "0.05/0" = " All MNAR: 5% Severity, 0% Miscarriage",
                                       "0/0.2" = "All MNAR: 0% Severity, 20% Miscarriage",
                                       "0.1/0.1" = "MAR+MNAR: 10% Severity, 10% Miscarriage",
                                       "0.2/0" = "All MAR: 20% Severity, 0% Miscarriage"))) +
    geom_hline(aes(yintercept = 0), col = "black", linetype = "dashed") +
    xlab("Effect of Initiation on the Risk of Miscarriage") + 
    ylab("Bias") +
    ggtitle(title) +
    scale_x_discrete(labels = c(
      "Decrease risk of miscarriage" = "Decrease",
      "No effect on risk of miscarriage" = "None",
      "Increase risk of miscarriage" = "Increase"
    )) +
    theme_bw() +
    theme(
      legend.title = element_text(size = 8),
      legend.text = element_text(size = 8),
      strip.text = element_text(size = 7.5),
      # strip.text.x.top = element_text(size=1),
      # strip.text.x = element_text(size=2),
      # strip.placement = "outside"
    ) +
    scale_colour_grey() 
  
  return(plot)
  
}





create_biasfigure_sens <- function(dataset, parameter, rr_preec, title){
  
  param <- sym(parameter)
  # rr_abort <- sym(rr_abort)
  rr_preeclampsia <- sym(rr_preec)
  
  plot <- dataset %>%
    # filter(!grepl("Sens", Cohort)) %>% 
    mutate(Analysis = ifelse(grepl("Sens", Cohort),
                             "Sensitivity Analysis",
                             "Primary Analysis")) %>% 
    filter(rr_preec == rr_preeclampsia) %>%
    filter(parameter == param) %>% 
    ggplot(aes(x = scenario, y = value, color = Cohort, shape = Analysis)) + # , shape = cohort
    geom_point(size = 2, position = position_dodge(0.5)) +
    facet_wrap(missing ~., nrow = 1, 
               labeller = labeller(missing = 
                                     c("0/0.05" = "All MNAR: 0% Severity, 5% Miscarriage",
                                       "0.025/0.025" = "MAR+MNAR: 2.5% Severity, 2.5% Miscarriage",
                                       "0.05/0" = " All MNAR: 5% Severity, 0% Miscarriage",
                                       "0/0.2" = "All MNAR: 0% Severity, 20% Miscarriage",
                                       "0.1/0.1" = "MAR+MNAR: 10% Severity, 10% Miscarriage",
                                       "0.2/0" = "All MAR: 20% Severity, 0% Miscarriage"))) +
    geom_hline(aes(yintercept = 0), col = "black", linetype = "dashed") +
    xlab("Effect of Initiation on the Risk of Miscarriage") + 
    ylab("Bias") +
    ggtitle(title) +
    scale_x_discrete(labels = c(
      "Decrease risk of miscarriage" = "Decrease",
      "No effect on risk of miscarriage" = "None",
      "Increase risk of miscarriage" = "Increase"
    )) +
    theme_bw() +
    theme(legend.title = element_text(size = 6), 
          legend.text = element_text(size = 6),
          strip.text = element_text(size = 7.5),
          legend.spacing.y = unit(0, 'cm'),
          legend.key.height = unit(0.16, 'in')) +
    scale_colour_grey() 
  
  return(plot)
  
}


```

## Without Sensitivity Analyses

### Initiation Decreases Risk of Preeclampsia

~5% of study participants are LTFU

```{r}

pdf("Bias Risk by Missingness - Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, 
              "Risk, Initiators", 
              "0.5",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct,
                "Risk, Non-Initiators", 
                "0.5",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk by Missingness difference - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Difference", "0.5",
                     "(C) Risk Difference")
dev.off()

pdf("Bias Risk ratio by Missingness - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Ratio", "0.5",
                     "(D) Risk Ratio")
dev.off()

# pdf("Bias Odds ratio by Missingness - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
# create_biasfigure_nosens(bias_figure_data2_5pct, "Odds Ratio", "0.5",
#                      "(E) Odds Ratio")
# dev.off()

```

~20% of study participants are LTFU

```{r}



pdf("Bias Risk by Missingness - Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, 
              "Risk, Initiators", 
              "0.5",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct,
                "Risk, Non-Initiators", 
                "0.5",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk Difference by Missingness - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, 
                         "Risk Difference", 
                         "0.5",
                         "(A) Risk Difference")
dev.off()

pdf("Bias Risk Ratio by Missingness - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Ratio", "0.5",
                     "(B) Risk Ratio")
dev.off()

# pdf("Bias Odds Ratio by Missingness - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
# create_biasfigure_nosens(bias_figure_data2_20pct, "Odds Ratio", "0.5",
#                      "(E) Odds Ratio")
# dev.off()

```


### Initiation Does not Affect Risk of Preeclampsia

~5% of the study population are LTFU.

```{r}

pdf("Bias Risk by Missingness - Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct , 
              "Risk, Initiators", 
              "1",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct,
                       "Risk, Non-Initiators", 
                "1",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk difference by Missingness - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Difference", 
                     "1", 
                     "(C) Risk Difference")
dev.off()

pdf("Bias Risk ratio by Missingness - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Ratio", "1", 
                     "(D) Risk Ratio")
dev.off()

# pdf("Bias Odds ratio by Missingness - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
# create_biasfigure_nosens(bias_figure_data2_5pct, "Odds Ratio", "1", 
#                      "(E) Odds Ratio")
# dev.off()

```


~20% of the study population are LTFU.

```{r}

pdf("Bias Risk by Missingness - Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, 
              "Risk, Initiators", 
              "1",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct,
                     "Risk, Non-Initiators", 
                     "1",
                     "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk difference by Missingness - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Difference", 
                     "1", 
                     "(A) Risk Difference")
dev.off()

pdf("Bias Risk ratio by Missingness - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Ratio", "1", 
                     "(B) Risk Ratio")
dev.off()

# pdf("Bias Odds ratio by Missingness - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
# create_biasfigure_nosens(bias_figure_data2_20pct, "Odds Ratio", "1", 
#                      "(E) Odds Ratio")
# dev.off()

```


## With Sensitivity Analyses

### Initiation Decreases Risk of Preeclampsia

~5% of study participants are LTFU

```{r}

pdf("Bias Risk by Missingness - Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, 
              "Risk, Initiators", "0.5",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct,
                   "Risk, Non-Initiators", 
                   "0.5",
                   "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk Difference by Missingness - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Difference", "0.5",
                   "(C) Risk Difference")
dev.off()

pdf("Bias Risk Ratio by Missingness - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Ratio", "0.5",
                   "(D) Risk Ratio")
dev.off()

# pdf("Bias Odds Ratio by Missingness - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
# create_biasfigure_sens(bias_figure_data2_5pct, "Odds Ratio", "0.5",
#                    "(E) Odds Ratio")
# dev.off()

```

~20% of study participants are LTFU

```{r}

pdf("Bias Risk by Missingness - Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, 
              "Risk, Initiators", "0.5",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct,
                       "Risk, Non-Initiators", "0.5",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk Difference by Missingness - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Difference", "0.5",
                   "(C) Risk Difference")
dev.off()

pdf("Bias Risk Ratio by Missingness - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Ratio", "0.5",
                   "(D) Risk Ratio")
dev.off()

# pdf("Bias Odds Ratio by Missingness - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
# create_biasfigure_sens(bias_figure_data2_20pct, "Odds Ratio", "0.5",
#                    "(E) Odds Ratio")
# dev.off()

```

### Initiation Does not Affect Risk of Preeclampsia

~5% of study participants are LTFU

```{r}

pdf("Bias Risk by Missingness - Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, 
              "Risk, Initiators", "1",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct,
                   "Risk, Non-Initiators", 
                   "1",
                   "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk Difference by Missingness - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Difference", "1",
                   "(C) Risk Difference")
dev.off()

pdf("Bias Risk Ratio by Missingness - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Ratio", "1",
                   "(D) Risk Ratio")
dev.off()

# # pdf("Bias Odds Ratio by Missingness - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_biasfigure_sens(bias_figure_data2_5pct, "Odds Ratio", "1",
#                    "(E) Odds Ratio")
# # dev.off()

```

~20% of study participants are LTFU

```{r}

pdf("Bias Risk by Missingness - Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, 
              "Risk, Initiators", "1",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk by Missingness - Non-Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct,
                       "Risk, Non-Initiators", "1",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk Difference by Missingness - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Difference", "1",
                   "(C) Risk Difference")
dev.off()

pdf("Bias Risk Ratio by Missingness - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Ratio", "1",
                   "(D) Risk Ratio")
dev.off()

# # pdf("Bias Risk Ratio by Missingness - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_biasfigure_sens(bias_figure_data2_20pct, "Odds Ratio", "1",
#                    "(E) Odds Ratio")
# # dev.off()

```





# OLD CODE

Saved in case needed later.

# Figures: Parameter Estimates by Effect on Miscarriage

Create the functions to output the figures.

```{r eval=FALSE}

# create_figure_nosens <- function(dataset, parameter, rr_preec, title){
#   
#   param <- sym(parameter)
#   # rr_abort <- sym(rr_abort)
#   rr_preeclampsia <- sym(rr_preec)
#   
#   plot <- dataset %>%
#     filter(!grepl("Sens", Cohort)) %>% 
#     filter(rr_preec == rr_preeclampsia) %>%
#     filter(parameter == param) %>% 
#     ggplot(aes(x = missing, y = value, color = Cohort, shape = Cohort)) + # , shape = cohort
#     geom_point(size = 3, position = position_dodge(0.5)) +
#     facet_wrap(scenario ~., nrow = 1) +
#     geom_hline(aes(yintercept = truth), col = "black", linetype = "dashed") + 
#     # ggtitle(bquote(.(param) ~ ": " ~ RR[Abortion] == .(rr_abortion) ~ 
#     #                " and " ~ RR[Preeclampsia] == .(rr_preeclampsia))) +
#     xlab("Approximate Percent Missing Due to Severity|Abortion") + 
#     ylab("Parameter Estimate") +
#     ggtitle(title) +
#     scale_x_discrete(labels = c(
#       "0/0.05" = "0|5", "0.025/0.025" = "2.5|2.5", "0.05/0" = "5|0",
#       "0/0.2" = "0|20", "0.1/0.1" = "10|10", "0.2/0" = "20|0"
#     )) +
#     theme(legend.title = element_text(size = 8), 
#           legend.text = element_text(size = 8)) +
#     scale_colour_grey() +
#     theme_bw()
#   
#   if (parameter == "Risk Ratio" | parameter == "Odds Ratio") {
#     plot <- plot + scale_y_log10() 
#   }
#   
#   return(plot)
#   
# }
# 
# 
# 
# create_figure_sens <- function(dataset, parameter, rr_preec, title){
#   
#   param <- sym(parameter)
#   # rr_abort <- sym(rr_abort)
#   rr_preeclampsia <- sym(rr_preec)
#   
#   plot <- dataset %>%
#     # filter(!grepl("Sens", Cohort)) %>% 
#     mutate(Analysis = ifelse(grepl("Sens", Cohort),
#                              "Sensitivity Analysis",
#                              "Primary Analysis")) %>% 
#     filter(rr_preec == rr_preeclampsia) %>%
#     filter(parameter == param) %>% 
#     ggplot(aes(x = missing, y = value, color = Cohort, shape = Analysis)) + # , shape = cohort
#     geom_point(size = 3, position = position_dodge(0.5)) +
#     facet_wrap(scenario ~., nrow = 1) +
#     geom_hline(aes(yintercept = truth), col = "black", linetype = "dashed") + 
#     # ggtitle(bquote(.(param) ~ ": " ~ RR[Abortion] == .(rr_abortion) ~ 
#     #                " and " ~ RR[Preeclampsia] == .(rr_preeclampsia))) +
#     xlab("Approximate Percent Missing Due to Severity|Abortion") + 
#     ylab("Parameter Estimate") +
#     ggtitle(title) +
#     scale_x_discrete(labels = c(
#       "0/0.05" = "0|5", "0.025/0.025" = "2.5|2.5", "0.05/0" = "5|0",
#       "0/0.2" = "0|20", "0.1/0.1" = "10|10", "0.2/0" = "20|0"
#     )) +
#     scale_colour_grey() +
#     theme_bw()
#   
#   if (parameter == "Risk Ratio" | parameter == "Odds Ratio") {
#     plot <- plot + scale_y_log10() 
#   }
#   
#   return(plot)
#   
# }


```

## Without Sensitivity Analyses

### Initiation Decreases Risk of Preeclampsia

~5% of study participants are LTFU

```{r eval=FALSE}

# # pdf("Risk - Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct %>% 
#                 filter(Cohort != "Sens: Trt Pregnancies Outcome" & 
#                          Cohort != "Sens: Untrt Pregnancies Outcome"), 
#               "Risk, Initiators", 
#               "0.5",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct%>% 
#                 filter(Cohort != "Sens: Trt Pregnancies Outcome" & 
#                          Cohort != "Sens: Untrt Pregnancies Outcome"),
#                 "Risk, Non-Initiators", 
#                 "0.5",
#                 "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk difference - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct, "Risk Difference", "0.5",
#                      "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct, "Risk Ratio", "0.5",
#                      "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct, "Odds Ratio", "0.5",
#                      "(E) Odds Ratio")
# # dev.off()

```

~20% of study participants are LTFU

```{r eval=FALSE}


# # pdf("Risk - Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct %>% 
#                 filter(Cohort != "Sens: Trt Pregnancies Outcome" & 
#                          Cohort != "Sens: Untrt Pregnancies Outcome"), 
#               "Risk, Initiators", 
#               "0.5",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct%>% 
#                 filter(Cohort != "Sens: Trt Pregnancies Outcome" & 
#                          Cohort != "Sens: Untrt Pregnancies Outcome"),
#                 "Risk, Non-Initiators", 
#                 "0.5",
#                 "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk difference - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, "Risk Difference", "0.5",
#                      "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, "Risk Ratio", "0.5",
#                      "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, "Odds Ratio", "0.5",
#                      "(E) Odds Ratio")
# # dev.off()

```


### Initiation Does not Affect Risk of Preeclampsia

~5% of the study population are LTFU.

```{r eval=FALSE}

# # pdf("Risk - Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct , 
#               "Risk, Initiators", 
#               "1",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct,
#                        "Risk, Non-Initiators", 
#                 "1",
#                 "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk difference - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct, "Risk Difference", 
#                      "1", 
#                      "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk ratio - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct, "Risk Ratio", "1", 
#                      "(D) Risk Ratio")
# # dev.off()
# # 
# # 
# # pdf("Odds ratio - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_5pct, "Odds Ratio", "1", 
#                      "(E) Odds Ratio")
# # dev.off()

```


~20% of the study population are LTFU.

```{r eval=FALSE}

# # pdf("Risk - Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, 
#               "Risk, Initiators", 
#               "1",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct,
#                      "Risk, Non-Initiators", 
#                      "1",
#                      "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk difference - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, "Risk Difference", 
#                      "1", 
#                      "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk ratio - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, "Risk Ratio", "1", 
#                      "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds ratio - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_nosens(figure_data2_20pct, "Odds Ratio", "1", 
#                      "(E) Odds Ratio")
# # dev.off()

```


## With Sensitivity Analyses

### Initiation Decreases Risk of Preeclampsia

~5% of study participants are LTFU

```{r eval=FALSE}

# # pdf("Risk - Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, 
#               "Risk, Initiators", "0.5",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct,
#                    "Risk, Non-Initiators", 
#                    "0.5",
#                    "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk Difference - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, "Risk Difference", "0.5",
#                    "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, "Risk Ratio", "0.5",
#                    "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, "Odds Ratio", "0.5",
#                    "(E) Odds Ratio")
# # dev.off()

```

~20% of study participants are LTFU

```{r eval=FALSE}

# # pdf("Risk - Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, 
#               "Risk, Initiators", "0.5",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct,
#                        "Risk, Non-Initiators", "0.5",
#                 "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk Difference - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, "Risk Difference", "0.5",
#                    "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, "Risk Ratio", "0.5",
#                    "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, "Odds Ratio", "0.5",
#                    "(E) Odds Ratio")
# # dev.off()

```

### Initiation Does not Affect Risk of Preeclampsia

~5% of study participants are LTFU

```{r eval=FALSE}

# # pdf("Risk - Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, 
#               "Risk, Initiators", "1",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct,
#                    "Risk, Non-Initiators", 
#                    "1",
#                    "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk Difference - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, "Risk Difference", "1",
#                    "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, "Risk Ratio", "1",
#                    "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_5pct, "Odds Ratio", "1",
#                    "(E) Odds Ratio")
# # dev.off()

```

~20% of study participants are LTFU

```{r eval=FALSE}

# # pdf("Risk - Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, 
#               "Risk, Initiators", "1",
#               "(A) Risk, Initiators")
# # dev.off()
# # 
# # pdf("Risk - Non-Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct,
#                        "Risk, Non-Initiators", "1",
#                 "(B) Risk, Non-Initiators")
# # dev.off()
# # 
# # pdf("Risk Difference - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, "Risk Difference", "1",
#                    "(C) Risk Difference")
# # dev.off()
# # 
# # pdf("Risk Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, "Risk Ratio", "1",
#                    "(D) Risk Ratio")
# # dev.off()
# # 
# # pdf("Odds Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
# #     height = 2, width = 10)
# create_figure_sens(figure_data2_20pct, "Odds Ratio", "1",
#                    "(E) Odds Ratio")
# # dev.off()

```





# Figures: Bias by Effect on Miscarriage

Create the functions to output the figures.

```{r eval=FALSE}

create_biasfigure_nosens <- function(dataset, parameter, rr_preec, title){
  
  param <- sym(parameter)
  # rr_abort <- sym(rr_abort)
  rr_preeclampsia <- sym(rr_preec)
  
  plot <- dataset %>%
    filter(!grepl("Sens", Cohort)) %>% 
    filter(rr_preec == rr_preeclampsia) %>%
    filter(parameter == param) %>% 
    ggplot(aes(x = missing, y = value, color = Cohort, shape = Cohort)) + # , shape = cohort
    geom_point(size = 3, position = position_dodge(0.5)) +
    facet_wrap(scenario ~., nrow = 1) +
    geom_hline(aes(yintercept = 0), col = "black", linetype = "dashed") +
    # ggtitle(bquote(.(param) ~ ": " ~ RR[Abortion] == .(rr_abortion) ~ 
    #                " and " ~ RR[Preeclampsia] == .(rr_preeclampsia))) +
    xlab("Approximate Percent Missing Due to Severity|Abortion") + 
    ylab("Bias") +
    ggtitle(title) +
    scale_x_discrete(labels = c(
      "0/0.05" = "0|5", "0.025/0.025" = "2.5|2.5", "0.05/0" = "5|0",
      "0/0.2" = "0|20", "0.1/0.1" = "10|10", "0.2/0" = "20|0"
    )) +
    theme(legend.title = element_text(size = 8), 
          legend.text = element_text(size = 8)) +
    scale_colour_grey() +
    theme_bw()
  
  return(plot)
  
}



create_biasfigure_sens <- function(dataset, parameter, rr_preec, title){
  
  param <- sym(parameter)
  # rr_abort <- sym(rr_abort)
  rr_preeclampsia <- sym(rr_preec)
  
  plot <- dataset %>%
    # filter(!grepl("Sens", Cohort)) %>% 
    mutate(Analysis = ifelse(grepl("Sens", Cohort),
                             "Sensitivity Analysis",
                             "Primary Analysis")) %>% 
    filter(rr_preec == rr_preeclampsia) %>%
    filter(parameter == param) %>% 
    ggplot(aes(x = missing, y = value, color = Cohort, shape = Analysis)) + # , shape = cohort
    geom_point(size = 3, position = position_dodge(0.5)) +
    facet_wrap(scenario ~., nrow = 1) +
    geom_hline(aes(yintercept = 0), col = "black", linetype = "dashed") + 
    # ggtitle(bquote(.(param) ~ ": " ~ RR[Abortion] == .(rr_abortion) ~ 
    #                " and " ~ RR[Preeclampsia] == .(rr_preeclampsia))) +
    xlab("Approximate Percent Missing Due to Severity|Abortion") + 
    ylab("Bias") +
    ggtitle(title) +
    scale_x_discrete(labels = c(
      "0/0.05" = "0|5", "0.025/0.025" = "2.5|2.5", "0.05/0" = "5|0",
      "0/0.2" = "0|20", "0.1/0.1" = "10|10", "0.2/0" = "20|0"
    )) +
    scale_colour_grey() +
    theme_bw()
  
  return(plot)
  
}


```

## Without Sensitivity Analyses

### Initiation Decreases Risk of Preeclampsia

~5% of study participants are LTFU

```{r eval=FALSE}

pdf("Bias Risk - Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct %>% 
                filter(Cohort != "Sens: Trt Pregnancies Outcome" & 
                         Cohort != "Sens: Untrt Pregnancies Outcome"), 
              "Risk, Initiators", 
              "0.5",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk - Non-Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct%>% 
                filter(Cohort != "Sens: Trt Pregnancies Outcome" & 
                         Cohort != "Sens: Untrt Pregnancies Outcome"),
                "Risk, Non-Initiators", 
                "0.5",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk difference - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Difference", "0.5",
                     "(C) Risk Difference")
dev.off()

pdf("Bias Risk ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Ratio", "0.5",
                     "(D) Risk Ratio")
dev.off()

pdf("Bias Odds ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Odds Ratio", "0.5",
                     "(E) Odds Ratio")
dev.off()


```

~20% of study participants are LTFU

```{r eval=FALSE}



pdf("Bias Risk - Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, 
              "Risk, Initiators", 
              "0.5",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk - Non-Initiators - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct,
                "Risk, Non-Initiators", 
                "0.5",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk difference - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Difference", "0.5",
                     "(C) Risk Difference")
dev.off()

pdf("Bias Risk ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Ratio", "0.5",
                     "(D) Risk Ratio")
dev.off()

pdf("Bias Odds ratio - Decrease risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Odds Ratio", "0.5",
                     "(E) Odds Ratio")
dev.off()

```


### Initiation Does not Affect Risk of Preeclampsia

~5% of the study population are LTFU.

```{r eval=FALSE}

pdf("Bias Risk - Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct , 
              "Risk, Initiators", 
              "1",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk - Non-Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct,
                       "Risk, Non-Initiators", 
                "1",
                "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk difference - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Difference", 
                     "1", 
                     "(C) Risk Difference")
dev.off()

pdf("Bias Risk ratio - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Risk Ratio", "1", 
                     "(D) Risk Ratio")
dev.off()

pdf("Bias Odds ratio - No effect risk of Preeclampsia - No sensitivity analyses - 5pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_5pct, "Odds Ratio", "1", 
                     "(E) Odds Ratio")
dev.off()

```


~20% of the study population are LTFU.

```{r eval=FALSE}

pdf("Bias Risk - Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, 
              "Risk, Initiators", 
              "1",
              "(A) Risk, Initiators")
dev.off()

pdf("Bias Risk - Non-Initiators - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct,
                     "Risk, Non-Initiators", 
                     "1",
                     "(B) Risk, Non-Initiators")
dev.off()

pdf("Bias Risk difference - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Difference", 
                     "1", 
                     "(C) Risk Difference")
dev.off()

pdf("Bias Risk ratio - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Risk Ratio", "1", 
                     "(D) Risk Ratio")
dev.off()

pdf("Bias Odds ratio - No effect risk of Preeclampsia - No sensitivity analyses - 20pct.pdf",
    height = 2, width = 10)
create_biasfigure_nosens(bias_figure_data2_20pct, "Odds Ratio", "1", 
                     "(E) Odds Ratio")
dev.off()

```


## With Sensitivity Analyses

### Initiation Decreases Risk of Preeclampsia

~5% of study participants are LTFU

```{r eval=FALSE}

# pdf("Bias Risk - Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, 
              "Risk, Initiators", "0.5",
              "(A) Risk, Initiators")
# dev.off()
# 
# pdf("Bias Risk - Non-Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct,
                   "Risk, Non-Initiators", 
                   "0.5",
                   "(B) Risk, Non-Initiators")
# dev.off()
# 
# pdf("Bias Risk Difference - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Difference", "0.5",
                   "(C) Risk Difference")
# dev.off()
# 
# pdf("Bias Risk Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Ratio", "0.5",
                   "(D) Risk Ratio")
# dev.off()
# 
# pdf("Bias Odds Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Odds Ratio", "0.5",
                   "(E) Odds Ratio")
# dev.off()

```

~20% of study participants are LTFU

```{r eval=FALSE}

# pdf("Bias Risk - Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, 
              "Risk, Initiators", "0.5",
              "(A) Risk, Initiators")
# dev.off()
# 
# pdf("Bias Risk - Non-Initiators - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct,
                       "Risk, Non-Initiators", "0.5",
                "(B) Risk, Non-Initiators")
# dev.off()
# 
# pdf("Bias Risk Difference - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Difference", "0.5",
                   "(C) Risk Difference")
# dev.off()
# 
# pdf("Bias Risk Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Ratio", "0.5",
                   "(D) Risk Ratio")
# dev.off()
# 
# pdf("Bias Odds Ratio - Decrease risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Odds Ratio", "0.5",
                   "(E) Odds Ratio")
# dev.off()

```

### Initiation Does not Affect Risk of Preeclampsia

~5% of study participants are LTFU

```{r eval=FALSE}

# pdf("Bias Risk - Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, 
              "Risk, Initiators", "1",
              "(A) Risk, Initiators")
# dev.off()
# 
# pdf("Bias Risk - Non-Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct,
                   "Risk, Non-Initiators", 
                   "1",
                   "(B) Risk, Non-Initiators")
# dev.off()
# 
# pdf("Bias Risk Difference - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Difference", "1",
                   "(C) Risk Difference")
# dev.off()
# 
# pdf("Bias Risk Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Risk Ratio", "1",
                   "(D) Risk Ratio")
# dev.off()
# 
# pdf("Bias Odds Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 5pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_5pct, "Odds Ratio", "1",
                   "(E) Odds Ratio")
# dev.off()

```

~20% of study participants are LTFU

```{r eval=FALSE}

# pdf("Bias Risk - Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, 
              "Risk, Initiators", "1",
              "(A) Risk, Initiators")
# dev.off()
# 
# pdf("Bias Risk - Non-Initiators - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct,
                       "Risk, Non-Initiators", "1",
                "(B) Risk, Non-Initiators")
# dev.off()
# 
# pdf("Bias Risk Difference - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Difference", "1",
                   "(C) Risk Difference")
# dev.off()
# 
# pdf("Bias Risk Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Risk Ratio", "1",
                   "(D) Risk Ratio")
# dev.off()
# 
# pdf("Bias Odds Ratio - No effect risk of Preeclampsia - Sensitivity analyses - 20pct.pdf",
#     height = 2, width = 10)
create_biasfigure_sens(bias_figure_data2_20pct, "Odds Ratio", "1",
                   "(E) Odds Ratio")
# dev.off()

```






